---
layout:     post
title:      半小时搞懂内存，指针和变量的关系
subtitle:   搞得你搞懂了就不会溢出了一样【笑】
date:       2018-03-21
author:     Max
header-img: img/post-bg-rixi3.png
catalog: true
tags:
    - Python
    - C++
	- 
---


## 前言
上次提到Numpy里面的数组和变量的底层原理，看了一下别的dalao写的教程，结果哦涉及底层原理和什么内存访问的我又看不懂了【C++基础没学好连指针都不知道是什么东西的后果，警告我们基础一定要打好】
随便科普了一下内存和变量的关系，填上了巨坑科科

首先起因是别人Numpy里面的一句话：
### 这个是起因
![ndarray.jpg](https://upload-images.jianshu.io/upload_images/10219317-7156270ce2909b87.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

>ndarray中的每个元素在内存中使用相同大小的块。 ndarray中的每个元素是数据类型对象的对象（称为 dtype）。
ndarray 对象由计算机内存中的一维连续区域组成，带有将每个元素映射到内存块中某个位置的索引方案。 内存块以按行（C 风格）或按列（FORTRAN 或 MatLab 风格）的方式保存元素。


黑人问号.jpg

来人话解释一下上面这句话【强行解释】
用C++的语法来解释的话，这个ndarray就是一个和C里面的数组很像的东西，在连续的内存块里面统一分配空间，然后头部尾部有指针指向内存块里的头和......
~~溢出溢出溢出空指针空指针空指针~~
不行不行不行我开始晕了，我要先复习一下数组的基本原理

## 正文

也许你们只学过Python不用数据类型定义的你们不知道曾经有一个时代我们被数据类型给支配过的时代，当时要定义一个整数要这么写:
```
//C++
int a=0;

//Java?或者是Flash?
var a:Number=100;
```
变量像箱子，数组像仓库,变量和数组都是放在内存里的。

### 0x01厅局级干部浮点型变量的退休生活

其实在内存里，就像是许许多多的街道，每条街道有它的名字，而街道上的每幢房子又按顺序地编了号，于是街道名和房子在街道上的编号就能确定内存中唯一的一幢房子，我们在这里认为所有的数据在内存中都是放在房子里。电脑就是依照这个原理找到所要的访问或修改的数据的。街道名和房子在街道上的编号就称为这个房子的地址。我们通常把地址表示为一串十六进制的数。

那么这些内存中的房子和我们所说的变量和数组是什么关系呢？在内存里的房子的大小是规定的，**每幢房子只能存储一个字节（Byte）的数据。**
有时候，一种类型的变量需要比较大的空间，比如一个浮点型的实数，一幢房子是放不下的，而是需要4幢房子的空间才能放得下。于是电脑就把连起来的4幢房子拼起来，**每幢房子放这个实数的一部分数据**。而这连起来的4幢房子，构成了一个能够存放浮点型实数的变量。
比如说Python，就是在你定义一个变量的时候规定的房子数量
**PS：我一般认为在内存里面的房子都是公家的计划经济房改房，每栋房子的面积都是一个字节【100平米】而且内部装饰一样~~（所谓的‘赫鲁晓夫玉米粒个个饱满’说的就是内存空间不变的梗）~~，所以在计算机里面，房子的大小这个概念其实是错误的，因为要实行对程序的~~共产主义~~改造，所以禁止讨论房子的大小【邪恶的资本主义讨论】，但是可以讨论房子的数量，所以不是‘一个变量的内存大小有100字节‘’，而是‘一个变量占了100个一字节大小的内存’**

我们认为，内存中的“房子”是客观存在的，每幢房子的大小一样，没有任何区别；而不同类型的变量“箱子”则是由若干幢房子拼接而成，箱子在内存中是不存在的，只是我们为了方便理解而臆想出来的。下面就是一个浮点型变量在内存中的情况，又名：厅局级干部浮点型变量的退休生活
![厅局级干部浮点型变量的退休生活.jpg](https://upload-images.jianshu.io/upload_images/10219317-aea4a1b88f8f15e0.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
我们用Python来查看一下不同变量的数据大小：
```
import sys

v = 1
print sys.getsizeof(v)

s = 'abc'
print sys.getsizeof(s)
```

### 0x02副省级数组的房地产市场

变量在内存中是由若干个相邻的“房子”拼接而成的，而数组在内存中则是由若干个**相邻**的数组元素按顺序拼接而成的。每个数组元素又相当于一个变量。下图就是副省级一维数组的房地产【把整条街都占领了】：
![副省级一维数组的房地产.jpg](https://upload-images.jianshu.io/upload_images/10219317-4e128da87e776931.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

一个数组中的所有元素**具有相同的数据类型**（在在C、C++、Java中都这样。）这使得想要做胶水的Python必须先往一个数组里面存取一个数据，同时存入这个数据的数据类型，在需要的时候再进行对应数据类型的读取，一个数组不把数据类型放在header（头部）里面自然慢啊

但是你有没有注意到一点，在Python中元素的内存空间是动态分配的，所以不存在内存溢出的问题，但是Numpy里面好像出现了溢出的问题，所以
偷懒的开发者把所有的数据转换成了字符数组进行存储，然后输出的时候再通过dtype来确定类型【这也是为什么Numpy使用了dtype以后一行就只能存储一种相同的数据类型的原因了吧】
```
a = np.array([1,2,'abc'],dtype=np.int)
Traceback (most recent call last):

  File "<ipython-input-3-d335375f98d4>", line 1, in <module>
    a = np.array([1,2,'abc'],dtype=np.int)

ValueError: invalid literal for int() with base 10: 'abc'
```
注：不能使用int存储字符串证明（在规定了数据类型的情况下）

真tm聪明，同时还节省了不同变量存储的硬伤：不同类型变量大小定义的问题

~~无聊的笔者起先还不相信，用iPython做了无聊的证明：~~
```
IPython 6.1.0 -- An enhanced Interactive Python.
import numpy as np
s = np.array([[1,  2],  [3,  'abc']])
s
Out[3]: 
array([['1', '2'],
       ['3', 'abc']],
      dtype='<U11')

from sys import getsizeof
print(getsizeof(s))
288

s[1]
Out[6]: 
array(['3', 'abc'],
      dtype='<U11')

print(getsizeof(s[1]))
96
print(getsizeof(s[0][0]))
82
print(getsizeof(s[0][1]))
82
print(getsizeof(s[1][1]))
84
s = np.array([[1,  2],  [3,  'abc'],[2.014658489,'中文测试']])
print(getsizeof(s[2][0]))
92
print(getsizeof(s[2][1]))
90
s[2][1]='中文测试，我tm就想看看如果我打这么多汉字他的内存大小会不会变？'
print(getsizeof(s[2][1]))
104
```

看来基于动态分配的不会出现熟悉的‘0xC00005’溢出错误，但是上面还是换汤不换药的，array基于字符串来储存，然后再用不同的类型来读取这种方式是比Python每读取一个变量就先判断他的数据类型来的高效【但是限制】多了，时间也减少了

md都用Python还担心什么TLE啊又不怕卡不是用户是不是

### 0x04 回到那句话

现在我们基本上已经理清楚了之前说的那句天书，我来总结一下：
ndarray里面每一个元素的数据类型是一样的，这样才能‘使用相同大小的块’，正因为是一样的数据类型，所以每个元素又受到dtype里面的元素的影响‘ndarray中的每个元素是数据类型对象的对象（称为 dtype）。’
至于数组是连续的，这个是因为Numpy好像用了什么奇奇怪怪的C语言写法来提升速度来着，这样也就导致受制于c的写法而在某些情况下无法体现出Python辣么简洁【只是我懒】

但是他快啊
**快啊**
少年你不是渴望做香港记者嘛【笑】

## 后记
mdzz这个本来是写在Numpy入门（一）里面，结果我因为这个话卡了一个下午差点以为tmd以前学的都白学了woc
这个真的真的是有点难理解了，还是多看看参考资料吧:

[对象数组_百度百科](https://baike.baidu.com/item/%E5%AF%B9%E8%B1%A1%E6%95%B0%E7%BB%84)
[Numpy教程](https://wizardforcel.gitbooks.io/ts-numpy-tut/content/0.html0)
[C++数组的存储|C++数组所占内存空间](http://c.biancheng.net/cpp/biancheng/view/42.html)

## 最后的最后
[在小姐姐的博客上来撩我吧](https://0xc000005.github.io/)
